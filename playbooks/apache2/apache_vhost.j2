# ======================================================
# ANSIBLE MANAGED
# ======================================================
{% if ssl_enabled %}
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName {{ domain }}
    ServerAdmin {{ admin_email }}
    DocumentRoot {{ document_root }}
    ErrorLog ${APACHE_LOG_DIR}/{{ log_prefix }}.error.log
    CustomLog ${APACHE_LOG_DIR}/{{ log_prefix }}.access.log combined

    # SSL Config
    Include /etc/letsencrypt/options-ssl-apache.conf
    SSLCertificateFile /etc/letsencrypt/live/{{ domain }}/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/{{ domain }}/privkey.pem

    # Proxy Config
    ProxyRequests Off
    ProxyPreserveHost On

    <Directory />
        Options Indexes FollowSymLinks MultiViews
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>
</IfModule>
{% endif %}

<VirtualHost *:80>
    ServerName {{ domain }}
    {% if alias %}
    ServerAlias {{ alias }}
    {% endif %}
    ServerAdmin {{ admin_email }}
    DocumentRoot {{ document_root }}

    # Load proxy modules
    LoadModule proxy_module /usr/lib/apache2/modules/mod_proxy.so
    LoadModule proxy_http_module /usr/lib/apache2/modules/mod_proxy_http.so

    ErrorLog ${APACHE_LOG_DIR}/{{ log_prefix }}.error.log
    CustomLog ${APACHE_LOG_DIR}/{{ log_prefix }}.access.log combined

    {% if ssl_enabled %}
    RewriteEngine on
    RewriteCond %{SERVER_NAME} ={{ domain }}
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
    {% endif %}
</VirtualHost>
